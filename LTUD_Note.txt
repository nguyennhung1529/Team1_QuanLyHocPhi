xét bảng KY_HOC_PHI
- Giá trị của bảng này không được nhập thủ công, mà được điền tự động (do bảng HOC_TAP)
***
- Bắt đầu học kỳ mới, sinh viên học tập các học phần. Khi HOC_TAP +record thì bảng KY_HOC_PHI 
sẽ cập nhật.

(chỉ được INSERT, UPDATE bảng xét trong kỳ hiện tại)
- Khi INSERT HOC_TAP
  Tại bảng KY_HOC_PHI:

     if tồn tại KY_HOC_PHI.MaKyHoc = HOC_PHAN.MaKyHoc:
	-- cập nhật bản ghi có KY_HOC_PHI.MaKyHoc = HOC_PHAN.MaKyHoc
	HocPhi = HocPhi + HOC_PHAN.SoTC * TIEN_TIN.TienTC
     else
	-- +1 record trong bảng
	MaKyHP = HOC_PHAN.MaKyHoc;
	NSV = SINH_VIEN.MSV;
	HocPhi = SUM(HOC_PHAN.SoTC * TIEN_TIN.TienTC); -- trong kỳ học đang xét
	DaDong = 0;


- Khi DELETE HOC_TAP của sinh viên SV001:
  Tại bảng KY_HOC_PHI:
     Tại record có KY_HOC_PHI.MaKyHoc = HOC_PHAN.MaKyHoc:
	-- cập nhật bản ghi có KY_HOC_PHI.MaKyHoc = HOC_PHAN.MaKyHoc
	HocPhi = HocPhi - HOC_PHAN.SoTC * TIEN_TIN.TienTC


***
- Khi INSERT BIEN_LAI (chỉ có thể insert biên lai trong năm mà nhà trường đang mở 
tức năm hiện tại)
  Tại bảng KY_HOC_PHI:
     
     if BIEN_LAI.Status = 1:
     	-- Cập nhật bản ghi có KY_HOC_PHI.MaKyHoc = BIEN_LAI.MaKyHoc:
	if BIEN_LAI.MaKyHoc = MaHocKy_Max: -- luôn đúng
	   DaDong = DaDong + BIEN_LAI.TienNop;
	   


- Khi UPDATE BIEN_LAI => cập nhật bản ghi trong KY_HOC_PHI
(chỉ có thể update TienNop và Status = 1 của những biên lai có Kỳ = Kỳ hiện tại)
  Tại bảng KY_HOC_PHI:
     Cập nhật bản ghi: KY_HOC_PHI.MaKyHoc = BIEN_LAI.MaKyHoc && KY_HOC_PHI.MSV = BIEN_LAI.MSV:

	if ( BIEN_LAI.Status(cũ) = 0 && BIEN_LAI.Status(mới) = 1 ): -- duyệt biên lai
		DaDong = DaDong + BIEN_LAI.TienNop;
	else if ( BIEN_LAI.TienNop(mới) != BIEN_LAI.TienNop(cũ) ):
		DaDong = DaDong - BIEN_LAI.TienNop(cũ) + BIEN_LAI.TienNop(mới);


- Khi DELETE BIEN_LAI => cập nhật bản ghi trong KY_HOC_PHI
(chỉ có thể delete những biên lai có kỳ = kỳ hiện tại)	
  Tại bảng KY_HOC_PHI:
     Cập nhật bản ghi: KY_HOC_PHI.MaKyHoc = BIEN_LAI.MaKyHoc && KY_HOC_PHI.MSV = BIEN_LAI.MSV:

	DaDong = DaDong - BIEN_LAI.TienNop(cũ);



======================================================
Xét NamHoc 2022, HocKy 1 (Quá khứ):
- Tổng học phí = Tổng học phí năm 2022, học kỳ 1
- Miễn Giảm = Miễn giảm năm 2022
- Cần đóng = Tổng học phí - Miễn giảm
- Đã đóng = Cần đóng
- Nợ = 0

Xét NamHoc 2022, HocKy 2 (Hiện tại)
- Tổng học phí = Tổng học phí năm 2022, học kỳ 2
- Miễn Giảm = Miễn giảm năm 2022
- Cần đóng = Tổng học phí - Miễn giảm
- Đã đóng = Nợ cũ (Tiền dôi ra năm 2022-1) + BIEN_LAI.TienNop
- Nợ = Tổng học phí - Miễn giảm - Đã đóng


Xét năm học 2022, học kỳ 3 (Tương lai):
Tại năm 2022-3, học phí kỳ trước đã được hoàn thành đóng tiền

* Học kỳ mới => HOC_TAP thêm bản ghi của năm và học kỳ mới
- Tổng học phí = Tổng học phí năm 2022, học kỳ 3
- Miễn Giảm = Miễn giảm năm 2022
- Đã đóng = Nợ (2022-2)
- Nợ = Tổng học phí - Miễn giảm - Đã đóng

* Update bản ghi năm 2022-2 (vì học phí kỳ 2022-2 đã được hoàn thành đóng tiền)
- Tổng học phí = Tổng học phí năm 2022, học kỳ 2
- Miễn Giảm = Miễn giảm năm 2022
- Đã đóng = Tổng học phí
- Nợ = 0

* Khi sinh viên Thực hiện nộp học phí -> biên lai => Update bản ghi hiện tại 2022-3:
- Tổng học phí = Tổng học phí năm 2022, học kỳ 3
- Miễn Giảm = Miễn giảm năm 2022
- Đã đóng = Nợ (2022-2) + BIEN_LAI.TienNop
- Nợ = Nợ - BIEN_LAI.TienNop

* Khi thực hiện update BIEN_LAI.TienNop
- Tổng học phí = Tổng học phí năm 2022, học kỳ 3
- Miễn Giảm = Miễn giảm năm 2022
- Đã đóng = Đã đóng - BIEN_LAI.TienNop(cũ) + BIEN_LAI.TienNop(mới)
- Nợ = Nợ + BIEN_LAI.TienNop (cũ) - BIEN_LAI.TienNop(mới)

* Khi thực hiện xóa BIEN_LAI của 1 sinh viên
- Tổng học phí = Tổng học phí năm 2022, học kỳ 3
- Miễn Giảm = Miễn giảm năm 2022
- Đã đóng = Đã đóng - BIEN_LAI.TienNop(cũ)
- Nợ = Nợ + BIEN_LAI.TienNop (cũ)



=> SỬ DỤNG TRIGGER CHO vw_TinhTrangHP

vw_TinhTrangHP (NamHoc, HocKy, MSV, HocPhi, MienGiam, CanDong, DaDong, ConNo)


NamHoc, HocKy, MSV, HocPhi, MienGiam <= SINH_VIEN, HOC_TAP, HOC_PHAN, MIEN_GIAM
CanDong <= HocPhi - MienGiam
DaDong <= if (SUM(BIEN_LAI.TienNop) - CanDong) > 0
	   	DaDong = CanDong;
		SUM(BIEN_LAI.TienNop) = SUM(BIEN_LAI.TienNop) - CanDong;
	  else
		DaDong = SUM(BIEN_LAI.TienNop)
ConNo = CanDong - DaDong


Còn Nợ (bản ghi cuối) 	= Tổng học phí - tổng miễn giảm - tổng đã đóng 
			= Cần đóng (bản ghi cuối) - Đã đóng (bản ghi cuối)



CREATE TABLE TinhTrangHP (NamHoc, HocKy, MSV, HocPhi, MienGiam, CanDong, DaDong, ConNo)
1 VS - n TinhTrangHP


===================================================================================
Status = 1 (Đã duyệt)

NamHoc, HocKy, MaSV, MaL, Ngày cập nhật, Người cập nhật => BIEN_LAI
Miễn giảm => DOI_TUONG (dựa theo học kỳ)
Số tiền cần đóng => HOC_TAP
Còn nợ => BIEN_LAI.TienNop - Số tiền cần đóng


BIEN_LAI.NamHoc, 
BIEN_LAI.HocKy, 
BIEN_LAI.MSV, 
SINH_VIEN.MaL,
DOI_TUONG.MucGiam,
Số tiền cần đóng,
BIEN_LAI.NgayCapNhat, 
BIEN_LAI.NguoiCapNhat

Năm 2022 Học kỳ 2, Sinh viên A thực hiện đóng học phí, thông tin trước khi đóng:
- Tiền Cần đóng = Tiền học phí kỳ 2022-2 -  Miễn giảm 2022 + Nợ 2022-1

Năm 2022 học kỳ 1, Sinh viên A thực hiện đóng học phí, thông tin trước khi đóng:
- Tiền Cần đóng = Tiền học phí kỳ 2022-1 -  Miễn giảm 2022 + Nợ 2021-2

Biên lai 2022-2: Sau khi đã đóng tiền năm 2022 học kỳ 2, sinh viên A xem thông tin
- Tiền học phí 2022-2

Nợ hiện tại = Tiền cần đóng - Tiền đã đóng
Tiền cần đóng hiện tại = tiền học phí - miễn giảm + nợ cũ




Số tiền cần đóng trong học kỳ  = số tiền tín học trong học kỳ 
				+ Số tiền nợ trong học kỳ trước
				- Miễn giảm trong học kỳ


Số tiền cần đóng = (tổng tất cả số tiền tín đã học - miễn giảm)_theo học kỳ
			- tổng tất cả tiền đã đóng trong biên lai

Tiền nợ:
- Nếu kỳ đang xét < Kỳ hiện tại:
	=> Tiền nợ = 0;

- Nếu kỳ đang xét = Kỳ hiện tại:
	=> Tiền nợ = Tổng tiền cần đóng - Tổng tiền đã đóng
		   = Tổng tiền học phí - Miễn giảm - Tổng tiền đã đóng



+ Nếu kỳ đang xét < Kỳ đang học 
	=> Số tiền cần đóng = tổng học phí - miễn giảm học kỳ đó

+ nếu Kỳ đang xét = Kỳ đang học 
	=> Số tiền cần đóng = Tổng hoc phí 
				+ Số tiền nợ trong học kỳ trước
				- Miễn giảm trong học kỳ đó
	=> update nợ kỳ trước = 0



======================= SỐ TIỀN CẦN ĐÓNG =======================





======================= Số tiền tín đã học =======================
SELECT SUM(HOC_PHAN.SoTC * TIEN_TIN.TienTC) AS 'SoTienCanDong'
FROM HOC_TAP, HOC_PHAN, SINH_VIEN, LOP, TIEN_TIN
WHERE
    HOC_TAP.MaHP = HOC_PHAN.MaHP
AND HOC_TAP.MSV = SINH_VIEN.MSV
AND SINH_VIEN.MaL = LOP.MaL
AND LOP.MaTT = TIEN_TIN.MaTT
AND SINH_VIEN.MSV = 'SV001'

-----------
SELECT MSV, MaHP, SoTC, TienTC 
FROM HOC_TAP, HOC_PHAN, SINH_VIEN, LOP, TIEN_TIN
WHERE
    HOC_TAP.MaHP = HOC_PHAN.MaHP
AND HOC_TAP.MSV = SINH_VIEN.MSV
AND SINH_VIEN.MaL = LOP.MaL
AND LOP.MaTT = TIEN_TIN.MaTT


======================= TỔNG SỐ TIỀN ĐÃ ĐÓNG =========================
SELECT BIEN_LAI.TienNop
FROM BIEN_LAI
WHERE BIEN_LAI.MSV = 'SV001'
